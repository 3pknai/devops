name: CI/CD Pipeline with GitHub Preview

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest flask
    
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Test with pytest
      run: |
        cat > test_app.py << 'EOF'
        import sys
        sys.path.insert(0, '.')
        
        try:
            from app import app
            print("âœ“ App imports successfully")
            
            with app.test_client() as client:
                response = client.get('/')
                assert response.status_code == 200
                print("âœ“ Root endpoint returns 200")
                
                response = client.get('/health')
                assert response.status_code == 200
                print("âœ“ Health endpoint returns 200")
                
            print("âœ“ All tests passed!")
        except Exception as e:
            print(f"âœ— Test failed: {e}")
            sys.exit(1)
        EOF
        
        python test_app.py

  build-push-and-preview:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/simple-web-app:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/simple-web-app:${{ github.sha }}
    
    - name: Run container in GitHub Actions
      run: |
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð² Ñ„Ð¾Ð½Ðµ
        docker run -d --name preview-app -p 5000:5000 ${{ secrets.DOCKERHUB_USERNAME }}/simple-web-app:latest
        sleep 5
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
        docker ps
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
        curl -f http://localhost:5000/health
        echo ""
        echo "=== Application is running locally in GitHub Actions ==="
        echo "Note: For public access, you would need to use ngrok or similar service"
        
        # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ
        echo "Container logs:"
        docker logs preview-app --tail 10
        
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ ÑˆÐ°Ð³Ð°
        echo "CONTAINER_RUNNING=true" >> $GITHUB_ENV
    
    - name: Create simple GitHub Pages preview
      if: success()
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚ÑƒÑŽ HTML-ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°Ð¼Ð¸
        mkdir -p public
        cat > public/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>DevOps Lab Preview</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .success { color: green; }
                .info { color: blue; }
                .container { border: 1px solid #ccc; padding: 20px; border-radius: 5px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ðŸš€ DevOps CI/CD Pipeline Results</h1>
                <p class="success">âœ… Pipeline executed successfully!</p>
                <p><strong>Application:</strong> Simple Flask Web App</p>
                <p><strong>Status:</strong> Container is running in GitHub Actions</p>
                <p><strong>Docker Image:</strong> ${{ secrets.DOCKERHUB_USERNAME }}/simple-web-app:latest</p>
                <p><strong>Commit SHA:</strong> ${{ github.sha }}</p>
                <hr>
                <p class="info">Note: The application is running inside GitHub Actions environment.</p>
                <p>For a publicly accessible preview, consider using services like:</p>
                <ul>
                    <li>ngrok (for tunneling)</li>
                    <li>GitHub Pages with static build</li>
                    <li>Vercel / Netlify for deployments</li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        
        echo "Preview page generated at public/index.html"
    
    - name: Upload preview artifact
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: preview-page
        path: public/
    
    - name: Cleanup
      if: always()
      run: |
        docker stop preview-app || true
        docker rm preview-app || true

