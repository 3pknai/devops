name: CI/CD Pipeline with GitHub Preview

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest flask
    
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Test with pytest
      run: |
        cat > test_app.py << 'EOF'
        import sys
        sys.path.insert(0, '.')
        
        try:
            from app import app
            print("‚úì App imports successfully")
            
            with app.test_client() as client:
                response = client.get('/')
                assert response.status_code == 200
                print("‚úì Root endpoint returns 200")
                
                response = client.get('/health')
                assert response.status_code == 200
                print("‚úì Health endpoint returns 200")
                
            print("‚úì All tests passed!")
        except Exception as e:
            print(f"‚úó Test failed: {e}")
            sys.exit(1)
        EOF
        
        python test_app.py

  build-push-and-preview:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/simple-web-app:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/simple-web-app:${{ github.sha }}
    
    - name: Run container in GitHub Actions
      run: |
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ —Ñ–æ–Ω–µ
        docker run -d --name preview-app -p 5000:5000 ${{ secrets.DOCKERHUB_USERNAME }}/simple-web-app:latest
        sleep 5
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
        docker ps
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        curl -f http://localhost:5000/health
        echo ""
        echo "=== Application is running locally in GitHub Actions ==="
        echo "Note: For public access, you would need to use ngrok or similar service"
        
        # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
        echo "Container logs:"
        docker logs preview-app --tail 10
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
        echo "CONTAINER_RUNNING=true" >> $GITHUB_ENV
    
    - name: Create simple GitHub Pages preview
      if: success()
      run: |
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        mkdir -p public
        cat > public/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>DevOps Lab Preview</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .success { color: green; }
                .info { color: blue; }
                .container { border: 1px solid #ccc; padding: 20px; border-radius: 5px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üöÄ DevOps CI/CD Pipeline Results</h1>
                <p class="success">‚úÖ Pipeline executed successfully!</p>
                <p><strong>Application:</strong> Simple Flask Web App</p>
                <p><strong>Status:</strong> Container is running in GitHub Actions</p>
                <p><strong>Docker Image:</strong> ${{ secrets.DOCKERHUB_USERNAME }}/simple-web-app:latest</p>
                <p><strong>Commit SHA:</strong> ${{ github.sha }}</p>
                <hr>
                <p class="info">Note: The application is running inside GitHub Actions environment.</p>
                <p>For a publicly accessible preview, consider using services like:</p>
                <ul>
                    <li>ngrok (for tunneling)</li>
                    <li>GitHub Pages with static build</li>
                    <li>Vercel / Netlify for deployments</li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        
        echo "Preview page generated at public/index.html"
    
    - name: Upload preview artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: preview-page
        path: public/
    
    - name: Cleanup
      if: always()
      run: |
        docker stop preview-app || true
        docker rm preview-app || true

  deploy-to-k8s:
    needs: build-push-and-preview  # –ó–∞–ø—É—Å–∫–∞—Ç—å –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–∞
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.34.0'  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –≤–µ—Ä—Å–∏—é, —á—Ç–æ –∏ –≤ Minikube
    
    - name: Configure kubectl with Minikube config
      env:
        MINIKUBE_IP: "192.168.49.2"  # –í–∞—à minikube ip
        KUBE_TOKEN: ${{ secrets.KUBE_TOKEN }}
      run: |
        kubectl config set-cluster minikube --server=https://$MINIKUBE_IP:8443 --insecure-skip-tls-verify=true
        kubectl config set-credentials github-actions --token=$KUBE_TOKEN
        kubectl config set-context minikube --cluster=minikube --user=github-actions
        kubectl config use-context minikube
    
    - name: Update image in deployment
      env:
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      run: |
        # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑ –≤ deployment.yaml
        sed -i "s|image:.*|image: $DOCKERHUB_USERNAME/simple-web-app:latest|g" k8s/deployment.yaml
        echo "=== Updated deployment.yaml ==="
        cat k8s/deployment.yaml | grep image:
    
    - name: Deploy to Kubernetes
      run: |
        echo "=== Applying manifests ==="
        kubectl apply -f k8s/
        
        echo "=== Checking deployment ==="
        kubectl rollout status deployment/simple-web-app-deployment --timeout=2m
        
        echo "=== Current pods ==="
        kubectl get pods -l app=simple-web-app
        
        echo "=== Current services ==="
        kubectl get service simple-web-app-service
